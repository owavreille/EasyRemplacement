
<div class="container-fluid m-3">
  <div class="card shadow">
    <div class="card-body">
      <h1>Planning des Remplacements</h1>
    <hr>

    <div class="d-flex justify-between flex-wrap m-3">
      <div>
        <%= link_to "Aujourd'hui", events_path(date: Date.current), class: 'btn btn-outline-secondary mt-2' %>
      </div>

      <div class="form-group m-2">
        <%= form_tag events_path, method: :get, class: 'row g-2 align-items-center' do %>
          <div class="col-auto">
            <%= date_field_tag :start_date, params[:start_date], class: 'form-control', placeholder: 'Sélectionnez une date' %>
          </div>
          <div class="col-auto">
            <%= submit_tag ">>", class: 'btn btn-outline-secondary' %>
          </div>
        <% end %>
      </div>

      <div class="d-flex ms-auto">
       <div class="form-group m-2">
        <%= form_tag events_path, method: :get, class: 'row g-2 align-items-center', id: 'doctor-form' do %>
          <div class="col-auto">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="doctorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Praticiens
              </button>
              <ul class="dropdown-menu" aria-labelledby="doctorDropdown">
                <% @doctors.each do |doctor| %>
                  <li>
                    <div class="form-check d-flex align-items-center">
                      <%= check_box_tag 'doctor_ids[]', doctor.id, @selected_doctor_ids.include?(doctor.id.to_s), id: "doctor_#{doctor.id}", class: 'form-check-input mx-0' %>
                      <%= label_tag "doctor_#{doctor.id}", "Dr #{doctor.last_name} #{doctor.first_name}", class: 'form-check-label dropdown-item mb-0', style: 'color: black; background-color: transparent;' %>
                    </div>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
          <div class="col-auto">
            <%= submit_tag ">>", class: 'btn btn-outline-secondary' %>
          </div>
        <% end %>
      </div>
      <div class="form-group m-2">
        <%= form_tag events_path, method: :get, class: 'row g-2 align-items-center', id: 'site-form' do %>
          <div class="col-auto">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="siteDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Sites
              </button>
              <ul class="dropdown-menu" aria-labelledby="siteDropdown">
                <% @sites.each do |site| %>
                  <li>
                    <div class="form-check d-flex align-items-center">
                      <%= check_box_tag 'site_ids[]', site.id, @selected_site_ids.include?(site.id.to_s), id: "site_#{site.id}", class: 'form-check-input mx-0' %>
                      <%= label_tag "site_#{site.id}", site.name, class: 'form-check-label dropdown-item mb-0', style: 'color: black; background-color: transparent;' %>
                    </div>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
          <div class="col-auto">
            <%= submit_tag ">>", class: 'btn btn-outline-secondary' %>
          </div>
        <% end %>
      </div>
    </div>
    </div>

    <div class="container-fluid">
      <div class="d-flex justify-content-between m-1"></div>
      <% col_class = 'col-lg-12' %>
      <div id="calendar" class="overflow-auto">

          <%= calendar(events: @events, number_of_days: 7) do |date, events| %>
        <% events_filtered_by_site = events.select { |event| params[:site_ids].present? && params[:site_ids].include?(event.site_id.to_s) } %>
        <% events_filtered_by_doctor = events.select { |event| params[:doctor_ids].present? && params[:doctor_ids].include?(event.doctor_id.to_s) } %>
        <% events_to_display = if params[:doctor_ids].present?
                                 events_filtered_by_doctor
                               elsif params[:site_ids].present?
                                 events_filtered_by_site
                               else
                                 events
                               end %>

          <%= date.strftime("%d/%m/%Y") %>
          <div class="card-columns" style="flex-wrap: wrap;">
            <% events_to_display.each do |event| %>
              <div class="card mb-1" style="border-left: 5px solid <%= event.site.color %>; min-width: 250px;">
                <div class="card-body">
                  <p class="text-center"><%= event.site.name %></p>
                  <hr>
                    <strong>Horaires :</strong> <%= event.start_time.strftime("%H:%M") %> - <%= event.end_time.strftime("%H:%M") %><br>
                    <strong>Médecin :</strong> Dr <%= event.doctor.last_name %> <%= event.doctor.first_name %><br>
                    <strong>Nb de Patients :</strong> <%= event.number_of_patients %><br>
                    <strong>Taux de Reversion :</strong> <%= event.reversion %> %<br>
                    <strong>Cs Aidée :</strong> <%= event.helper ? 'oui' : 'non' %>
                  <hr>

                  <div class="text-center">
                    <div class="d-flex justify-content-center">
                      <% if current_user && current_user.admin? %>
                        <%= link_to edit_event_path(event), class: 'btn btn-outline-primary m-1' do %>
                          <i class="bi bi-pencil"></i>
                        <% end %>
                        <%= button_to event_path(event), method: :delete, data: { "turbo-confirm": 'Voulez-vous vraiment supprimer cette plage ?' }, class: 'btn btn-outline-danger m-1' do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      <% end %>

                      <% if event.user_id.present? %>
                        <%= link_to "#", class: 'btn btn-secondary m-1', disabled: true, style: 'pointer-events: none;' do %>
                          Réservé
                        <% end %>
                      <% else %>
                        <%= link_to event_path(event), method: :get, class: 'btn btn-primary m-1' do %>
                          Détails
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if current_user && current_user.admin? %>
        <div class="d-flex justify-content-end m-1">
          <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
          <%= link_to new_event_path do %>
          <i class="bi bi-plus-circle-fill text-primary" style="font-size: 3rem;"></i>
          <% end %>
         </div>
        </div>

      <% end %>
     </div>
    </div>
   </div>
  </div>
</div>
