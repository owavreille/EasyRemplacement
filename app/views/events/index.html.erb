<div class="container-fluid m-3">
  <div class="card shadow-lg">
    <div class="card-header">
      <h1>Planning des Remplacements</h1>
    </div>

    <div class="d-flex justify-content-end m-1">
      <div class="form-group mx-2">
        <%= form_tag events_path, method: :get, class: 'd-grid' do %>
          <%= select_tag :doctor_id, options_for_select(Doctor.all.map { |doctor| [doctor.last_name, doctor.id] }, params[:doctor_id]), prompt: "Tous les Médecins", class: 'form-control' %>
          <%= submit_tag "Filtrer", class: 'btn btn-primary mt-2' %>
        <% end %>
      </div>

      <div class="form-group mx-2">
        <%= form_tag events_path, method: :get, class: 'd-grid' do %>
          <%= select_tag :site_id, options_for_select(Site.all.map { |site| [site.name, site.id] }, params[:site_id]), prompt: "Tous les Sites", class: 'form-control' %>
          <%= submit_tag "Filtrer", class: 'btn btn-primary mt-2' %>
        <% end %>
      </div>
    </div>

    <div class="container-fluid">
      <% col_class = 'col-lg-12' %>
      <div class="<%= col_class %>">
        <%= calendar(events: @events, number_of_days: 5) do |date, events| %>
          <% events_filtered_by_site = events.select { |event| event.site_id == params[:site_id].to_i } if params[:site_id].present? %>
          <% events_filtered_by_doctor = events.select { |event| event.doctor_id == params[:doctor_id].to_i } if params[:doctor_id].present? %>
          <% events_to_display = if params[:doctor_id].present?
                                   events_filtered_by_doctor
                                 elsif params[:site_id].present?
                                   events_filtered_by_site
                                 else
                                   events
                                 end %>

          <%= date.strftime("%d/%m/%Y") %>
          <div class="card-columns">
            <% events_to_display.each do |event| %>
              <div class="card">
                <div class="card-header text-center" style="background-color: <%= event.site.color %>">
                  <div><%= event.site.name %></div>
                </div>
                <div class="card-body">
                  <div><u>Horaires :</u> <%= event.start_time.strftime("%H:%M") %> - <%= event.end_time.strftime("%H:%M") %></div>
                  <div><u>Médecin :</u> Dr <%= event.doctor.last_name %> <%= event.doctor.first_name %> </div>
                  <div><u>Nb de Patients:</u> <%= event.number_of_patients %></div>
                  <div><u>Taux de Reversion:</u> <%= event.reversion %> % </div>
                  <div><u>Cs Aidée:</u> <%= event.helper ? 'oui' : 'non' %></div>

                  <div class="text-center">
                    <div class="d-flex justify-content-center">
                      <% if current_user && current_user.admin? %>
                        <%= link_to edit_event_path(event), class: 'btn btn-outline-primary m-1' do %>
                          <i class="bi bi-pencil"></i>
                        <% end %>
                        <%= button_to event_path(event), method: :delete, data: { "turbo-confirm": 'Voulez-vous vraiment supprimer cette plage ?' }, class: 'btn btn-outline-danger m-1' do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      <% end %>

                      <% if event.user_id.present? %>
                        <%= link_to "#", class: 'btn btn-secondary m-1', disabled: true, style: 'pointer-events: none;' do %>
                          Réservé
                        <% end %>
                      <% else %>
                        <%= button_to booking_event_path(event), method: :put, data: { "turbo-confirm": 'Confirmez vous réaliser le remplacement sélectionné ?' }, class: 'btn btn-primary m-1' do %>
                          Réserver
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if current_user && current_user.admin? %>
        <div class="d-flex justify-content-end m-1">
          <%= link_to "Ajouter une Plage de Remplacement", new_event_path, class: 'btn btn-success mt-2'%>
        </div>
      <% end %>
    </div>
  </div>
</div>
